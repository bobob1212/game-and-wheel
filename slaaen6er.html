<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Slå en 6'er - Bedst ud af 5</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #lobby, #game { display: none; }
    button { margin: 10px; padding: 10px 20px; }

    #popup {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #popupContent {
      background:white;
      padding:20px;
      border-radius:10px;
      min-width:250px;
      text-align:center;
      box-shadow:0 0 15px rgba(0,0,0,0.5);
    }
    #popup button { margin-top:15px; padding:8px 20px; }

    #playerListInGame {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    /* 🌙 DARK MODE STYLING */
    body.dark {
      background-color: #1e293b;
      color: #f1f1f1;
    }

    body.dark button {
      background: #eee;
      color: #000; /* 🖤 Sort tekst i mørk tilstand */
      border: 1px solid #555;
    }

    body.dark #playerListInGame {
      background: #1e1e1e;
      color: #f1f1f1;
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    /* 💡 Lys tilstand standard */
    #darkToggle {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>🎲 Slå en 6'er</h1>

<button id="darkToggle" onclick="toggleDarkMode()">🌙 Dark Mode</button>

  <div id="start">
    <button onclick="createGame()">Opret spil</button>
    <br><br>
    <input type="text" id="joinCode" placeholder="Indtast kode">
    <button onclick="joinGame()">Join spil</button>
  </div>

  <div id="lobby">
    <h2>Lobby</h2>
    <p>Din kode: <span id="gameCode"></span></p>
    <input type="text" id="newName" placeholder="Skriv dit navn">
    <button onclick="changeName()">Skift navn</button>
    <p id="playerCount"></p>
    <p id="playerList"></p>
    <button onclick="setReady()">✅ Klar</button>
    <button onclick="leaveGame()">🚪 Log ud</button>
  </div>

  <div id="popup">
    <div id="popupContent">
      <p id="popupMessage"></p>
      <button onclick="closePopup()">OK</button>
    </div>
  </div>

<div id="game">
  <h2>Selve spillet</h2>

<div id="playerListInGame">
  <strong>🏆 Sejre:</strong><br>
  <div id="winList"></div>

  <br>
  <strong>📅 Runde:</strong><br>
  <div id="roundStatus"></div>
</div>


  <p id="gameInfo"></p>
  <button onclick="rollDice()">🎲 Slå terning</button>
  <p id="myRoll"></p>
  <div id="scoreboard"></div>
  <button onclick="leaveGame()">🚪 Log ud</button>
</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, onDisconnect, remove } 
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDjRJyWfmS6l1BaJvGcXa30t1s0P8YfOaw",
      authDomain: "slaa-en-6er.firebaseapp.com",
      databaseURL: "https://slaa-en-6er-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "slaa-en-6er",
      storageBucket: "slaa-en-6er.firebasestorage.app",
      messagingSenderId: "797063178229",
      appId: "1:797063178229:web:d54ea194d3fa682486a2bc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const MAX_PLAYERS = 4;

    let gameId = null;
    let playerId = null;
    let playerName = null;

    window.createGame = function() {
      gameId = Math.floor(1000 + Math.random() * 9000);
      playerId = "p" + Date.now();
      playerName = "Spiller 1";
      set(ref(db, "games/" + gameId), {
        host: playerId,
        status: "venter",
        round: 1,
        players: {
          [playerId]: { name: playerName, ready: false, score: 0, wins: 0 }
        }
      });
      const playerRef = ref(db, "games/" + gameId + "/players/" + playerId);
      onDisconnect(playerRef).remove();
      document.getElementById("start").style.display = "none";
      document.getElementById("lobby").style.display = "block";
      document.getElementById("gameCode").innerText = gameId;
      listenLobby();
    };

    window.joinGame = function() {
      gameId = document.getElementById("joinCode").value;
      if (!/^\d{4}$/.test(gameId)) { showPopup("Ugyldig kode!"); return; }

      onValue(ref(db, "games/" + gameId), snapshot => {
        if (!snapshot.exists()) { showPopup("Denne kode findes ikke!"); return; }

        const players = snapshot.val().players || {};
        if (Object.keys(players).length >= MAX_PLAYERS) {
          showPopup("Der er allerede " + MAX_PLAYERS + " spillere!");
          return;
        }

        playerId = "p" + Date.now();
        playerName = "Spiller " + (Object.keys(players).length + 1);
        update(ref(db, "games/" + gameId + "/players/" + playerId), {
          name: playerName, ready: false, score: 0, wins: 0
        });
        const playerRef = ref(db, "games/" + gameId + "/players/" + playerId);
        onDisconnect(playerRef).remove();
        document.getElementById("start").style.display = "none";
        document.getElementById("lobby").style.display = "block";
        document.getElementById("gameCode").innerText = gameId;
        listenLobby();
      }, { onlyOnce: true });
    };

    window.changeName = function() {
      const newName = document.getElementById("newName").value;
      if (!newName) return;
      update(ref(db, "games/" + gameId + "/players/" + playerId), { name: newName });
      playerName = newName;
    };

    window.setReady = function() {
      update(ref(db, "games/" + gameId + "/players/" + playerId), { ready: true });
    };

    window.leaveGame = function() {
      const gameRef = ref(db, "games/" + gameId);
      const playerRef = ref(db, "games/" + gameId + "/players/" + playerId);
      remove(playerRef);
      document.getElementById("game").style.display = "none";
      document.getElementById("lobby").style.display = "none";
      document.getElementById("start").style.display = "block";
    };

    window.showPopup = function(msg) {
      document.getElementById("popupMessage").innerText = msg;
      document.getElementById("popup").style.display = "flex";
    };
    window.closePopup = function() {
      document.getElementById("popup").style.display = "none";
    };

    function listenLobby() {
      onValue(ref(db, "games/" + gameId), snapshot => {
        const game = snapshot.val();
        if (!game) return;
        const players = game.players || {};
        let list = "Spillere:<br>";
        let allReady = true;
        for (const pid in players) {
          const p = players[pid];
          list += p.name + (p.ready ? " ✅" : " ❌") + "<br>";
          if (!p.ready) allReady = false;
        }
        document.getElementById("playerList").innerHTML = list;
        if (allReady && game.status === "venter" && Object.keys(players).length >= 2) {
          update(ref(db, "games/" + gameId), { status: "spiller" });
          startGame();
        }
        document.getElementById("playerCount").innerText = "Spillere: " + Object.keys(players).length + " / " + MAX_PLAYERS;
      });
    }

    function startGame() {
      document.getElementById("lobby").style.display = "none";
      document.getElementById("game").style.display = "block";
      const turnRef = ref(db, "games/" + gameId + "/turn");
      onValue(turnRef, snap => {
        if (!snap.exists()) {
          onValue(ref(db, "games/" + gameId + "/players"), s => {
            const ids = Object.keys(s.val());
            update(ref(db, "games/" + gameId), { turn: ids[0] });
          }, { onlyOnce: true });
        }
      });
      listenGame();
    }

    window.rollDice = function() {
      const turnRef = ref(db, "games/" + gameId + "/turn");
      onValue(turnRef, snapshot => {
        const currentTurn = snapshot.val();
        if (currentTurn !== playerId) { showPopup("Det er ikke din tur!"); return; }

        const roll = Math.floor(Math.random() * 6) + 1;
        const playerRef = ref(db, "games/" + gameId + "/players/" + playerId);
        onValue(playerRef, snap => {
          const me = snap.val();
          let newScore = (me.score || 0) + roll;
          update(playerRef, { roll: roll, score: newScore });

          if (newScore >= 50) {
            // Vind runden
            update(playerRef, { wins: (me.wins || 0) + 1 });
            onValue(ref(db, "games/" + gameId), gSnap => {
              const game = gSnap.val();
              if (!game) return;
              const round = game.round || 1;
              const nextRound = round + 1;
              const totalRounds = 5;

              // Tjek om nogen har 3 sejre
              const players = game.players;
              let winnerOfGame = null;
              for (const pid in players) {
                if ((players[pid].wins || 0) + (pid === playerId ? 1 : 0) >= 3)
                  winnerOfGame = players[pid].name;
              }

              if (winnerOfGame) {
                showPopup("🏆 " + winnerOfGame + " vandt spillet bedst ud af 5!");
                setTimeout(() => { remove(ref(db, "games/" + gameId)); }, 5000);
              } else if (nextRound <= totalRounds) {
                showPopup(me.name + " vandt runde " + round + "!");
                // Nulstil point til næste runde
                for (const pid in players) {
                  update(ref(db, "games/" + gameId + "/players/" + pid), { score: 0, roll: null });
                }
                update(ref(db, "games/" + gameId), { round: nextRound });
              } else {
                // Hvis 5 runder spillet → find samlet vinder
                let bestName = null, bestWins = -1;
                for (const pid in players) {
                  if (players[pid].wins > bestWins) {
                    bestWins = players[pid].wins;
                    bestName = players[pid].name;
                  }
                }
                showPopup("🏆 " + bestName + " vandt bedst ud af 5 med " + bestWins + " sejre!");
                setTimeout(() => { remove(ref(db, "games/" + gameId)); }, 5000);
              }
            }, { onlyOnce: true });
            return;
          }

          // Skift tur
          onValue(ref(db, "games/" + gameId + "/players"), snap2 => {
            const ids = Object.keys(snap2.val());
            const currentIndex = ids.indexOf(playerId);
            const nextId = ids[(currentIndex + 1) % ids.length];
            update(ref(db, "games/" + gameId), { turn: nextId });
          }, { onlyOnce: true });
        }, { onlyOnce: true });
      }, { onlyOnce: true });
    };

    // 🌙 Dark Mode funktion
    window.toggleDarkMode = function () {
      const body = document.body;
      body.classList.toggle("dark");

      // Gem brugerens valg lokalt
      const mode = body.classList.contains("dark") ? "dark" : "light";
      localStorage.setItem("themeMode", mode);

      // Opdatér knap-ikon
      document.getElementById("darkToggle").innerText = 
        mode === "dark" ? "☀️ Light Mode" : "🌙 Dark Mode";
    };

    // 💾 Husk tidligere valg ved genindlæsning
    window.addEventListener("load", () => {
      const saved = localStorage.getItem("themeMode");
      if (saved === "dark") {
        document.body.classList.add("dark");
        document.getElementById("darkToggle").innerText = "☀️ Light Mode";
      }
    });

    function listenGame() {
    onValue(ref(db, "games/" + gameId), snapshot => {
        const game = snapshot.val();
        if (!game) return;
        const players = game.players;

        // 🎯 Scoreboard (viser navne, point og slog)
        let board = "<h3>🎯 Scoreboard</h3>";
        for (const pid in players) {
        const p = players[pid];
        board += `${p.name}: ${p.score || 0} point` +
                (p.roll ? ` (slog: ${p.roll})` : "") +
                `<br>`;
        if (pid === playerId && p.roll) {
            document.getElementById("myRoll").innerText = "Du slog: " + p.roll;
        }
        }
        document.getElementById("scoreboard").innerHTML = board;

        // 🏆 Sejre
        let wins = "";
        for (const pid in players) wins += `${players[pid].name}: ${players[pid].wins || 0}<br>`;
        document.getElementById("winList").innerHTML = wins;

        // 📅 Runde
        const currentRound = game.round || 1;
        document.getElementById("roundStatus").innerHTML = `Runde ${currentRound} af 5`;

        // ⏳ Tur-info
        const turn = game.turn;
        if (turn === playerId)
        document.getElementById("gameInfo").innerText = "🎯 Det er DIN tur!";
        else
        document.getElementById("gameInfo").innerText =
            "⏳ " + (players[turn]?.name || "") + " slår nu...";
    });
    }
  </script>
</body>
</html>
