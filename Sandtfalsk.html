<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Sandt eller Falsk</title>
<style>
body{font-family:Arial,sans-serif;background:#203a43;color:white;margin:0;display:flex;align-items:center;justify-content:center;height:100vh;overflow:hidden;}
#main{background: rgba(255, 255, 255, 0.07);padding: 50px 100px;border-radius: 25px;text-align: center;box-shadow: 0 0 35px rgba(0, 0, 0, 0.7);backdrop-filter: blur(14px);border:1px solid rgba(255,255,255,0.2);border: 2px solid #ffffff;width: 90%;max-width: 1000px; transition: all 0.3s ease;}
h1{font-size:32px;margin-bottom:10px;}
button{padding:12px 25px;border:none;border-radius:8px;background:#00b894;color:white;font-weight:700;cursor:pointer;transition:0.2s;box-shadow:0 0 10px rgba(0,255,180,0.5);}
button:hover{opacity:0.9;transform:scale(1.03);}
textarea{width:90%;max-width:500px;height:80px;border-radius:6px;padding:10px;font-size:15px;resize:none;}
label{display:block;margin-top:15px;margin-bottom:8px;}
select{padding:8px;border-radius:6px;margin-bottom:10px;}
#resultText,#storyText{white-space:pre-line;}
.same-size {width:150px; height:32px; border:none; border-radius:6px;background:#00b894; color:white; font-size:14px; text-align:center; box-sizing:border-box;margin:6px; padding:4px 10px; cursor:pointer;transition:all 0.2s ease; font-weight:600;box-shadow:0 0 6px rgba(0,255,180,0.35);}
.same-size:hover {transform:scale(1.05); background:#00d4a1;}
.same-size:disabled {background:#555; color:#ccc; cursor:not-allowed; box-shadow:none;}
body.dark{background:#000!important;color:white;}
body.halloween{background:radial-gradient(circle at center,#1a0008 0%,#000 100%);color:#ffb84d}
body.halloween #main{background:rgba(40,0,20,.9);border:2px solid #ff6600;box-shadow:0 0 25px #ff6600}
@media(max-width:900px){body{flex-direction:column;height:auto;padding:20px;}#main{max-width:100%;padding:40px;}}
</style>
<button id="themeToggle" class="same-size" style="position:absolute;top:25px;right:40px;">üåô M√∏rk tilstand</button>
</head>
<body>
<div id="main">
  <h1>Sandt eller Falsk</h1>
  <p id="roundStatus"></p>

  <div id="myTurn" style="display:none;">
    <p>Skriv en kort historie:</p>
    <textarea id="storyInput"></textarea><br>
    <label>Er den sand eller falsk?</label><br>
    <select id="truthSelect">
      <option value="true">Sand</option>
      <option value="false">Falsk</option>
    </select><br><br>
    <button class="same-size" onclick="submitStory()">Send historie</button>
  </div>

  <div id="guessTurn" style="display:none;">
    <p id="storyText"></p>
    <button class="same-size" onclick="submitGuess(true)">Sandt</button>
    <button class="same-size" onclick="submitGuess(false)">Falsk</button>
  </div>

  <div id="waitTurn" style="display:none;">
    <p id="waitMessage">‚è≥ Vent p√• din tur...</p>
  </div>

  <div id="roundResult" style="display:none;">
    <p id="resultText"></p>
  </div>

  <div id="truthScoreboard"></div>
  <br>
  <button class="same-size" onclick="backToLobby()">‚¨ÖÔ∏è Tilbage til lobby</button>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {getDatabase,ref,set,update,onValue,get,remove,onDisconnect} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// === Firebase config ===
const firebaseConfig={apiKey:"AIzaSyBJPveZ_kuPqB2GCfFuDuYgrUjlxtHaq5w",authDomain:"lobby-dc329.firebaseapp.com",databaseURL:"https://lobby-dc329-default-rtdb.europe-west1.firebasedatabase.app",projectId:"lobby-dc329",storageBucket:"lobby-dc329.firebasestorage.app",messagingSenderId:"244192634791",appId:"1:244192634791:web:c527a06b7d88b5782eb882"};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

// === Tema ===
document.addEventListener("DOMContentLoaded", () => {
  const body = document.body;

  // === DARK MODE KNAP ===
  const themeToggle = document.createElement("button");
  themeToggle.id = "themeToggle";
  themeToggle.className = "same-size";
  themeToggle.textContent = "üåô M√∏rk tilstand";
  Object.assign(themeToggle.style, {
    position: "absolute",
    top: "25px",
    right: "40px",
    height: "34px",
    width: "150px",
    fontWeight: "600"
  });
  document.body.appendChild(themeToggle);

  themeToggle.addEventListener("click", () => {
    // Hvis Halloween er aktiv, g√∏r ingenting
    if (body.classList.contains("halloween")) return;

    body.classList.toggle("dark");
    themeToggle.textContent = body.classList.contains("dark")
      ? "‚òÄÔ∏è Lys tilstand"
      : "üåô M√∏rk tilstand";
  });

  // === S√ÜSON-KNAP (Halloween) ===
  const today = new Date();
  const m = today.getMonth() + 1;
  const d = today.getDate();

  const seasonButton = document.createElement("button");
  seasonButton.id = "seasonButton";
  seasonButton.className = "same-size";
  Object.assign(seasonButton.style, {
    position: "absolute",
    top: "25px",
    right: "210px",
    height: "34px",
    width: "150px",
    fontWeight: "600",
    display: "none"
  });
  document.body.appendChild(seasonButton);

  // Kun aktiv i oktober / start november
  const showHalloween = (m === 10) || (m === 11 && d <= 10);
  if (!showHalloween) return;

  seasonButton.style.display = "block";
  seasonButton.textContent = "üéÉ Aktiver";
  seasonButton.style.background = "#8b0000";
  seasonButton.style.color = "#fff4e0";
  seasonButton.style.boxShadow = "0 0 12px #ff6600";
  seasonButton.style.border = "2px solid #ff6600";

  let wasDarkBeforeHalloween = false;

  seasonButton.addEventListener("click", () => {
    const active = body.classList.toggle("halloween");

    if (active) {
      // Husk dark mode-status og sl√• den midlertidigt fra
      wasDarkBeforeHalloween = body.classList.contains("dark");
      body.classList.remove("dark");
      console.log("üéÉ Halloween aktiveret ‚Äì dark mode gemt som:", wasDarkBeforeHalloween);
    } else {
      // Gendan tidligere tilstand
      if (wasDarkBeforeHalloween) {
        body.classList.add("dark");
        console.log("üåô Gendanner Dark mode");
      } else {
        body.classList.remove("dark");
        console.log("‚òÄÔ∏è Gendanner Lys tilstand");
      }
    }

    // Opdater Halloween-knap
    seasonButton.textContent = active ? "üéÉ Deaktiver" : "üéÉ Aktiver";
    seasonButton.style.background = active ? "#ff6600" : "#8b0000";
  });
});

// === Hent parametre ===
const urlParams=new URLSearchParams(window.location.search);
const gameId=urlParams.get("gameId");
const playerId=urlParams.get("playerId");
let playerName=sessionStorage.getItem("playerName")||"Ukendt spiller";
const gameRef=ref(db,"games/"+gameId);
const playersRef=ref(db,"games/"+gameId+"/players");

let currentTurn=null;
const DEFAULT_ROUNDS=3;
const NEXT_ROUND_DELAY=5;

// === Debug info ===
console.log("üÜï Tilf√∏jer spilleren:", playerName);
console.log("üîπ Forbinder til spil:", gameId, "som", playerId);

// === S√∏rg for at spilleren findes ===
async function ensurePlayerExists() {
  try {
    const playerRef = ref(db, "games/" + gameId + "/players/" + playerId);
    const snap = await get(playerRef);

    if (!snap.exists()) {
      await set(playerRef, { name: playerName, ready: true, score: 0 });
    } else if (!snap.val().name) {
      await update(playerRef, { name: playerName });
    }

    onDisconnect(playerRef).remove();
  } catch (err) {
    console.error("‚ö†Ô∏è Fejl i ensurePlayerExists:", err);
  }
}

// === Start spil ===
(async () => {
  await ensurePlayerExists();

  onValue(gameRef, snap => {
    const game = snap.val();
    if (!game) return;
    if (!game.turn) initGameTurn();
    updateUI(game);
  });
})();

async function initGameTurn(){
  const psnap=await get(playersRef);const players=psnap.val()||{};
  const ids=Object.keys(players);
  const host=ids[0]; // f√∏rste spiller starter
  await update(gameRef,{turn:host,round:{story:null,guesses:{},result:null},roundCount:0});
}

function updateUI(game){
  if(game.status==="slut"){showWinner(game);return;}
  currentTurn=game.turn;const round=game.round||{};
  document.getElementById("roundStatus").innerText="Runde "+((game.roundCount||0)+1)+" af "+DEFAULT_ROUNDS;

  if(currentTurn===playerId&&!round.story){showSection("myTurn");}
  else if(round.story&&!round.result){
    if(playerId!==currentTurn&&!(round.guesses&&round.guesses[playerId])){
      document.getElementById("storyText").innerText=round.story;showSection("guessTurn");
    }else if(playerId!==currentTurn){showSection("waitTurn");}
  }else if(round.result){document.getElementById("resultText").innerText=round.result;showSection("roundResult");}
  else{showSection("waitTurn");}
  updateScoreboard(game.players);
}

function showSection(id){
  ["myTurn","guessTurn","waitTurn","roundResult"].forEach(s=>{
    document.getElementById(s).style.display=(s===id)?"block":"none";
  });
}

window.submitStory=function(){
  const story=document.getElementById("storyInput").value.trim();
  const truth=document.getElementById("truthSelect").value==="true";
  if(!story)return;
  update(gameRef,{round:{story,correct:truth,guesses:{},storyteller:playerId}});
  document.getElementById("storyInput").value="";
  showSection("waitTurn");
};

window.submitGuess=function(choice){
  update(ref(db,"games/"+gameId+"/round/guesses"),{[playerId]:choice});
  checkRoundEnd();
};

async function checkRoundEnd(){
  const snap=await get(gameRef);const game=snap.val();if(!game||!game.round)return;
  const players=game.players||{};const guesses=game.round.guesses||{};
  const totalPlayers=Math.max(0,Object.keys(players).length-1);
  if(Object.keys(guesses).length===totalPlayers){
    let resultText="Historien var "+(game.round.correct?"Sand ‚úÖ":"Falsk ‚ùå")+"\n";let updates={};
    for(const pid in guesses){const guess=guesses[pid];
      if(guess===game.round.correct){updates[pid]=(players[pid].score||0)+1;resultText+=players[pid].name+" g√¶ttede rigtigt! +1p\n";}
      else{resultText+=players[pid].name+" g√¶ttede forkert.\n";}}
    for(const pid in updates){update(ref(db,"games/"+gameId+"/players/"+pid),{score:updates[pid]});}
    update(ref(db,"games/"+gameId+"/round"),{result:resultText});
    setTimeout(nextTurn,NEXT_ROUND_DELAY*1000);
  }
}

async function nextTurn(){
  const snap=await get(gameRef);const game=snap.val();if(!game)return;
  const players=game.players||{};const ids=Object.keys(players);
  const curIndex=ids.indexOf(currentTurn);const nextIndex=(curIndex+1)%ids.length;
  let newRound=game.roundCount||0;if(nextIndex===0)newRound++;
  if(newRound>=DEFAULT_ROUNDS){
    let ranking=Object.values(players).map(p=>({name:p.name,score:p.score||0})).sort((a,b)=>b.score-a.score);
    let resultHtml="üèÜ Slutresultat<br>";ranking.forEach((p,i)=>{resultHtml+=(i+1)+". "+p.name+" ‚Äì "+p.score+" point<br>";});
    update(gameRef,{status:"slut",finalResult:resultHtml});return;
  }
  update(gameRef,{turn:ids[nextIndex],round:{story:null,guesses:{},result:null},roundCount:newRound});
}

function updateScoreboard(players){
  let html="<h3>Scoreboard</h3>";
  Object.values(players||{}).forEach(p=>{html+=`<p>${p.name}: ${p.score||0}p</p>`;});
  document.getElementById("truthScoreboard").innerHTML=html;
}

function showWinner(game){
  document.getElementById("main").innerHTML="<h2>"+game.finalResult+"</h2><button onclick='backToLobby()'>‚¨ÖÔ∏è Tilbage til lobby</button>";
}

window.backToLobby = async function () {
  const playerRef = ref(db, "games/" + gameId + "/players/" + playerId);
  const playerResultRef = ref(db, "games/" + gameId + "/results/" + playerId);
  const gameRef = ref(db, "games/" + gameId);

  try {
    await remove(playerRef);
    await remove(playerResultRef);

    const playersSnap = await get(ref(db, "games/" + gameId + "/players"));
    const remaining = playersSnap.val();

    if (!remaining) {
      await remove(gameRef);
    }

    window.location.href = "Lobby.html";
  } catch (err) {
    console.error("Fejl ved forladelse:", err); // du kan beholde denne ene for fejl
  }
};
</script>
</body>
</html>








